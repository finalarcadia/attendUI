<!--
Login and Register Code
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="intro-card">
	<template>
	<style include="shared-styles">
	:host {
		--my-color: var(--accent-color);
	}

	paper-material {
		border-radius: 2px;
		height: 100%;
		padding: 16px 16px 16px 16px;
		width: calc(98.66% - 16px);
		margin: 16px auto;
		background: white;
	}

	paper-input {
		--paper-input-container-focus-color: var(--my-color);
		display: inline-block;
		width: 130px;
	}

	paper-button {
		display: inline-block;
		float: right;
		color: var(--my-color);
	}

	paper-icon-button {
		display: inline-block;
		color: var(--my-color);
	}

	paper-radio-button {
		--paper-radio-button-checked-color: var(--my-color);
		--paper-radio-button-checked-ink-color: var(--my-color);
	}

	paper-dropdown-menu {
		width: 292px;
	}

	#large {
		width: 292px;
	}

	#infoText {
		@apply(--paper-font-subhead);
		color: var(--my-color);
	}
	</style>

	<!-- Begin login-->
	<paper-material>
		<iron-icon icon="perm-identity"></iron-icon>
		<paper-input label="Username" value="{{username}}" no-label-float></paper-input>
		<iron-icon icon="lock-outline"></iron-icon>
		<paper-input label="Password" value="{{password}}" no-label-float></paper-input>
		<paper-button on-click="_login">Login</paper-button>
	</paper-material>

	<span id="infoText">
		Don't have an account? Create one!
	</span>

	<!-- Begin register-->
	<paper-material id="paperParent">
		<iron-icon icon="sort"></iron-icon>
		<paper-radio-group selected="{{userDetailData.userType}}">
			<paper-radio-button name="admin" on-click="universityListOff">Admin</paper-radio-button>
			<paper-radio-button name="professor" on-click="universityListOn">Professor</paper-radio-button>
			<paper-radio-button name="student" on-click="universityListOn">Student</paper-radio-button>
		</paper-radio-group>
		<br>
		
		<!-- Admin university -->
		<div id="adminUniversity" style="visibility: hidden;">
		<iron-icon icon="social:school"></iron-icon>
		<paper-input id="large" label="University" value="{{universityData.universityName}}" no-label-float></paper-input>
		<br>
		</div>

		<!-- Regular University -->
		<div id="regularUniversity" style="visibility: hidden;">
		<iron-icon icon="social:school"></iron-icon>
		<iron-ajax
			auto
			id="universityListAjax"
			method="GET"
			handle-as="json"
			last-response="{{universityList}}"
			url="http://127.0.0.1:8000/myapp/universities/">
    	</iron-ajax>
		<paper-dropdown-menu label="Select university">
			<paper-listbox class="dropdown-content" selected-item="{{universitySelection}}">
				<!-- University List-->
				<template is="dom-repeat" items="{{universityList.results}}">
        			<paper-item>
						<general-card element-color="{{elementColor}}" text$="{{item.universityName}}" pk$="{{item.universityPK}}" icon="social:school"></general-card>
					</paper-item>
    			</template>
			</paper-listbox>
		</paper-dropdown-menu>
		<br>
		</div>

		<paper-button on-click="getInfo">INFO</paper-button>
		
		<iron-icon icon="perm-identity"></iron-icon>
		<paper-input label="Username" value="{{userData.username}}" no-label-float></paper-input>
		<iron-icon icon="lock-outline"></iron-icon>
		<paper-input label="Password" value="{{userData.password}}" no-label-float></paper-input>
		<br>
		<iron-icon icon="face"></iron-icon>
		<paper-input label="First name" value="{{userData.first_name}}" no-label-float></paper-input>
		<paper-input label="Last name" value="{{userData.last_name}}" no-label-float></paper-input><br>
		<iron-icon icon="folder-shared"></iron-icon>
		<paper-input label="Id" value="{{userDetailData.schoolId}}" no-label-float></paper-input>
		<paper-button on-click="_register">Register</paper-button>
		<iron-ajax
			id = "loginAjax"
			method="GET"
			handle-as="json"
			on-response="_handleLoginResponse"
			last-response="{{responseData}}"
    		url="http://127.0.0.1:8000/myapp/auth/{{username}}/{{password}}/">
		</iron-ajax>
		<iron-ajax
			id = "fetchUserDetailAjax"
			method="GET"
			handle-as="json"
			on-response="_handleFetchResponse"
			last-response="{{responseData}}"
    		url="http://127.0.0.1:8000/myapp/userdetails/{{responseData.id}}/">
		</iron-ajax>
		<iron-ajax
			id = "registerAjax"
			method="POST"
			content-type="application/x-www-form-urlencoded"
			body="{{userData}}"
			on-response="_handleRegisterResponse"
			last-response="{{responseData}}"
    		url="http://127.0.0.1:8000/myapp/users/">
		</iron-ajax>
		<iron-ajax
			id = "createUserDetailAjax"
			method="POST"
			content-type="application/x-www-form-urlencoded"
			body="{{userDetailData}}"
    		url="http://127.0.0.1:8000/myapp/userdetails/">
		</iron-ajax>
		<iron-ajax
			id = "createUniversityAjax"
			method="POST"
			content-type="application/x-www-form-urlencoded"
			body="{{universityData}}"
			on-response="_handleCreateUniversity"
			last-response="{{responseData}}"
    		url="http://127.0.0.1:8000/myapp/universities/">
		</iron-ajax>
		
</paper-material>

</template>

<script>

Polymer({
	is: 'intro-card',

	properties: {

		elementColor: {
			type: String,
			value: 'var(--accent-color)'
		},
		
		username: {
			type: String
		},
		
		password: {
			type: String
		},
		
		userData: {
			type: Object,
			value: function() { return {}; }	
		},
		
		userDetailData: {
			type: Object,
			value: function() { return {}; }	
		},
		
		universityData: {
			type: Object,
			value: function() { return {}; }	
		},
		
		universityList: {
			type: Object,
			value: function() { return {}; }	
		},
		
		universitySelection: {
			type: Object,
			value: function() { return {}; }	
		},
		
		responseData: {
			type: Object,
			value: function() { return {}; }	
		},
		
		loading: {
			type: Boolean,
			notify: true,
			value: false
		}

	},

	ready: function() {
		this.customStyle['--my-color'] = this.elementColor;
		this.updateStyles();
	},
	
	getInfo: function(){
		console.log("response", this.responseData);
		console.log("user", document.querySelector('#global').userPK);
		console.log("uni", document.querySelector('#global').universityPK);
		console.log("type", document.querySelector('#global').userType);
     },
	 
	 universityListOn: function(){
		 this.$.regularUniversity.style.visibility='visible';
		 this.$.adminUniversity.style.visibility='hidden';
		 //Polymer.dom(this.$.paperParent).appendChild(this.$.regularUniversity);
		 //Polymer.dom(this.$.paperParent).removeChild(this.$.adminUniversity);
	 },
	 
	 universityListOff: function(){
		 this.$.adminUniversity.style.visibility='visible';
		 this.$.regularUniversity.style.visibility='hidden';
		 //Polymer.dom(this.$.paperParent).appendChild(this.$.adminUniversity);
		 //Polymer.dom(this.$.paperParent).removeChild(this.$.regularUniversity);
	 },
	 
	 _login: function(){
		 this.$.loginAjax.generateRequest();
	 },
	 
	 _handleLoginResponse: function() {
		document.querySelector('#global').userPK = this.responseData.id;
		this.$.fetchUserDetailAjax.generateRequest();
	 },
	 
	 _handleFetchResponse: function() {
		document.querySelector('#global').universityPK = this.responseData.universityKey;
		document.querySelector('#global').userType = this.responseData.userType;
	 },
	 
	 _register: function(){
		 //handle userType
		document.querySelector('#global').userType = this.userDetailData.userType;
		if (this.userDetailData.userType == "admin")
			this.$.createUniversityAjax.generateRequest()
		else
			this.$.registerAjax.generateRequest();
	},
	
	_handleCreateUniversity: function() {
		//handle global admin university
		document.querySelector('#global').universityPK = this.responseData.universityPK;
		console.log("uni", document.querySelector('#global').universityPK);
		this.userDetailData.universityKey = document.querySelector('#global').universityPK
		this.$.registerAjax.generateRequest();
	},
	
	_handleRegisterResponse: function(){
		//handle global other user's university
		if (document.querySelector('#global').userType != "admin"){
			document.querySelector('#global').universityPK = this.universitySelection.firstElementChild.pk;
			this.userDetailData.universityKey = document.querySelector('#global').universityPK
		}
		//handle global user PK
		document.querySelector('#global').userPK = this.responseData.id;
		this.userDetailData.userIdKey = document.querySelector('#global').userPK
		this.$.createUserDetailAjax.generateRequest();
	  }
});
</script>
</dom-module>
